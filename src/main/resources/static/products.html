<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω S·∫£n ph·∫©m</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">

<div class="container my-4">
    <h2 class="text-success mb-4">Qu·∫£n l√Ω S·∫£n ph·∫©m (Price ‚Üë)</h2>

    <!-- Form th√™m / s·ª≠a -->
    <form id="productForm" class="row g-3 bg-white p-3 border rounded shadow-sm">
        <input type="hidden" id="productId">
        <div class="col-md-3">
            <label class="form-label">Title</label>
            <input type="text" class="form-control border-success" id="productTitle" placeholder="T√™n s·∫£n ph·∫©m">
        </div>
        <div class="col-md-2">
            <label class="form-label">Quantity</label>
            <input type="number" class="form-control border-success" id="productQuantity" placeholder="S·ªë l∆∞·ª£ng">
        </div>
        <div class="col-md-2">
            <label class="form-label">Price</label>
            <input type="number" class="form-control border-success" id="productPrice" placeholder="Gi√°">
        </div>
        <div class="col-md-3">
            <label class="form-label">User ID</label>
            <input type="number" class="form-control border-success" id="userId" placeholder="ID ng∆∞·ªùi t·∫°o">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-success w-100">üíæ L∆∞u</button>
        </div>
    </form>

    <hr class="my-4">

    <table class="table table-success table-striped table-bordered text-center align-middle shadow-sm" id="productTable">
        <thead class="table-success">
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>User ID</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Load danh s√°ch s·∫£n ph·∫©m (theo gi√° tƒÉng d·∫ßn)
    function loadProducts() {
        const query = `
            query {
                getAllProductsSortedByPrice {
                    id
                    title
                    quantity
                    price
                    user { id }
                }
            }
        `;

        $.ajax({
            url: "/graphql",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ query }),
            success: function(response) {
                if (response.errors) {
                    console.error("GraphQL errors:", response.errors);
                    return;
                }
                const products = response.data.getAllProductsSortedByPrice;
                let rows = "";
                products.forEach(p => {
                    rows += `<tr>
                                <td>${p.id}</td>
                                <td>${p.title}</td>
                                <td>${p.quantity}</td>
                                <td>${p.price}</td>
                                <td>${p.user ? p.user.id : ""}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-success me-1" 
                                        onclick="editProduct(${p.id}, '${p.title}', ${p.quantity}, ${p.price}, ${p.user ? p.user.id : 0})">‚úèÔ∏è S·ª≠a</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${p.id})">üóëÔ∏è X√≥a</button>
                                </td>
                             </tr>`;
                });
                $("#productTable tbody").html(rows);
            },
            error: function(err) {
                console.error("AJAX error:", err);
            }
        });
    }

    // Submit form th√™m / s·ª≠a
    $("#productForm").submit(function(e) {
        e.preventDefault();
        const id = $("#productId").val();
        const title = $("#productTitle").val();
        const quantity = parseInt($("#productQuantity").val());
        const price = parseFloat($("#productPrice").val());
        const userId = parseInt($("#userId").val());

        if (!title || isNaN(price) || isNaN(userId)) {
            alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß Title, Price v√† User ID!");
            return;
        }

        let mutation;
        if (id) {
            // Update
            mutation = `
                mutation {
                    updateProduct(
                        id: ${id}, 
                        title: "${title}", 
                        price: ${price}, 
                        quantity: ${quantity}, 
                        description: "Kh√¥ng c√≥ m√¥ t·∫£", 
                        userId: ${userId}
                    ) {
                        id title quantity price
                    }
                }
            `;
        } else {
            // Create
            mutation = `
                mutation {
                    createProduct(
                        title: "${title}", 
                        price: ${price}, 
                        quantity: ${quantity}, 
                        description: "Kh√¥ng c√≥ m√¥ t·∫£", 
                        userId: ${userId}
                    ) {
                        id title quantity price
                    }
                }
            `;
        }

        $.ajax({
            url: "/graphql",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ query: mutation }),
            success: function(response) {
                if (response.errors) {
                    console.error("GraphQL errors:", response.errors);
                    alert("‚ùå L·ªói khi l∆∞u s·∫£n ph·∫©m!");
                    return;
                }
                $("#productForm")[0].reset();
                $("#productId").val("");
                loadProducts();
            },
            error: function(err) {
                console.error("AJAX error:", err);
            }
        });
    });

    // X√≥a s·∫£n ph·∫©m
    function deleteProduct(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?")) return;
        const mutation = `
            mutation {
                deleteProduct(id: ${id})
            }
        `;
        $.ajax({
            url: "/graphql",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ query: mutation }),
            success: function(response) {
                if (response.errors) {
                    console.error("GraphQL errors:", response.errors);
                    return;
                }
                loadProducts();
            },
            error: function(err) {
                console.error("AJAX error:", err);
            }
        });
    }

    // S·ª≠a s·∫£n ph·∫©m
    function editProduct(id, title, quantity, price, userId) {
        $("#productId").val(id);
        $("#productTitle").val(title);
        $("#productQuantity").val(quantity);
        $("#productPrice").val(price);
        $("#userId").val(userId);
    }

    $(document).ready(function() {
        loadProducts();
    });
</script>
</body>
</html>
